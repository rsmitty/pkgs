name: musl
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - image: "{{ .TOOLS_IMAGE }}"
steps:
  - sources:
      - url: https://www.musl-libc.org/releases/musl-1.2.0.tar.gz
        destination: musl.tar.gz
        sha256: c6de7b191139142d3f9a7b5b702c9cae1b5ee6e7f57e582da9328629408fd4e8
        sha512: 58bd88189a6002356728cea1c6f6605a893fe54f7687595879add4eab283c8692c3b031eb9457ad00d1edd082cfe62fcc0eb5eb1d3bf4f1d749c0efa2a95fec1
    prepare:
      - |
        export PATH=${TOOLCHAIN}/cross/bin:${PATH}

        tar -xzf musl.tar.gz --strip-components=1

        mkdir /bin
        ln -sv /toolchain/bin/bash /bin/sh

        mkdir build
        cd build

        # From https://www.musl-libc.org/doc/1.0.0/manual.html:
        #    $(syslibdir), $(includedir), and $(libdir) refer to the paths
        #    chosen at build time (by default, /lib, $(prefix)/include, and
        #    $(prefix)/lib, respectively)
        ../configure \
        --prefix=/usr
    build:
      - |
        cd build
        make -j $(nproc)
    install:
      - |
        cd build
        make DESTDIR=/rootfs install
finalize:
  - from: /rootfs
    to: /
